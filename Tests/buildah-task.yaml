apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: buildah-task
  namespace: dev
spec:
  params:
    - name: image
      type: string
      description: "Image name with tag"
    - description: The Git commit SHA to use as the image tag
      name: commit-sha
      type: string
  workspaces:
    - name: repo
      description: "Workspace containing the cloned repo"
  steps:
    - name: build
      image: quay.io/buildah/stable
      script: |
        #!/bin/sh
        set -e
        echo "Listing repo contents:"
        ls -la $(workspaces.repo.path)
        echo "Building image $(params.image):$(params.commit-sha)"
        buildah bud -f $(workspaces.repo.path)/Dockerfile -t $(params.image):$(params.commit-sha) $(workspaces.repo.path)
        echo "Pushing image $(params.image):$(params.commit-sha)"
        buildah push --tls-verify=false $(params.image):$(params.commit-sha)
      securityContext:
        privileged: true
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
  volumes:
    - name: varlibcontainers
      emptyDir: {}

