apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy-k8s
spec:
  params:
    - name: image
      description: Image name to deploy
      type: string
  workspaces:
    - name: repo
      description: Workspace containing deployment manifests
  steps:
    - name: deploy
      image: rancher/kubectl:v1.32.9
      script: |
        #!/bin/sh
        set -e

        echo "Updating deployment with image $(params.image)..."

        # Replace image in deployment.yaml
        sed -i "s|image: .*|image: $(params.image)|" $(workspaces.repo.path)/k8s/deployment.yaml

        # Apply manifests
        kubectl apply -f $(workspaces.repo.path)/k8s/deployment.yaml
        kubectl apply -f $(workspaces.repo.path)/k8s/service.yaml

        echo "Deployment applied successfully!"
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        privileged: false

